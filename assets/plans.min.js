/*
SH: this file coordinates flow between email collection and plans pages and checkout among other functions on these 2 pages.

Note: 

discount price showing code is still is on dev/sven
this file is not yet minified and there is no other source file despite the name of this file

For A/B tests:

url?email=false will skip email page when on plans page and email hasn't been entered yet
url?menu=true will show tabs, menu=false will clear it

*/
//{ //scope

let test = false; //enable/disable console messages and other
let page;
let href = window.location.href;
if(href.includes('pages/email')){
  page = "email"
}else if(href.includes('pages/plans')){
  page = "plans"
}
//localStorage.setItem('planPageLanding',page); //?

/*
https://support.rechargepayments.com/hc/en-us/articles/360008682454-Applying-discount-code-to-checkout-automatically

url for special discount and going directly to checkout if comming from landing page. going to email page if no email. 
https://sprinly.com/pages/plans?email=sdhoman@earthlink.net&discount=20OFFOVER3MONTHS&checkout=true 
*/
if(getUrlParam('checkout') === 'true') { //go to checkout
  //console.log('to checkout')
  $('body').hide();
  let variant_id = 37606794526915; //6 meal plan
  localStorage.setItem("discount",getUrlParam('discount'));
  localStorage.setItem("checkout", true);

  let email = getUrlParam('email');

  if(email && email.includes('@')) {
    localStorage.setItem("customerEmail", email);
    //checkout(variant_id, null, false); //variant_id, start_date, regular
  }else{
    localStorage.setItem('mealPlanId', variant_id);
    localStorage.removeItem("customerEmail");
    //window.location.href = '/pages/email';
  }
  checkout(variant_id, null, false);
}

const getCookie = function(cname) {
  let name = cname + "=";
  let decodedCookie = decodeURIComponent(document.cookie);
  let ca = decodedCookie.split(';');
  for(let i = 0; i <ca.length; i++) {
    let c = ca[i];
    while (c.charAt(0) == ' ') {
      c = c.substring(1);
    }
    if (c.indexOf(name) == 0) {
      return c.substring(name.length, c.length);
    }
  }
  return "";
}

const postData = async (url = "", data = {}) => {
  const response = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(data),
  });

  return response.json();
};

const checkEmailExistsOnRecharge = (email) => {
  if(test) console.log('check email');
  let app_url = "https://sprinly.herokuapp.com/validateEmail";
  let href = window.location.href;
  if(href.includes('calm-mountain')) {
    app_url = "https://sprinly-staging.herokuapp.com/validateEmail";
  }
  postData(app_url, {email}).then((data) => {
    if(test) console.log('in check email', email, data);
    console.log(data);
    if (data && data.userFound) {
      //console.log('email exists');
      window.location.href = "/account/login?account=true&email_found=true";
    }else{
      return
    }
  });
}

let email = localStorage.getItem("customerEmail") || null;

if(test) console.log('page',page);

console.log('fb', localStorage.getItem("fb_pixel_id"));

let plan_id = localStorage.getItem('mealPlanId') || null;
let plan_page = "plans";

//redirects
//if(page === 'email' && email && !plan_id) window.location.href = '/pages/plans';
//if(page === 'plans' && !email) window.location.href = '/pages/email'; //go to email page first
console.log('load 2', email, plan_id);

/*************************************************************************** */

//start date on plans page
let start_date;

const edit_delivery_date = () => {
    $('#delivery_date').show();
    //let len = $('#delivery_date option').length;
    //$('#delivery_date').attr('size', len);
    $('#delivery_date').attr("size","3");
    $('#close_delivery_date').show();
    $('#edit_delivery_date').hide();
    $('#selected_delivery_date').hide();
}

const close_delivery_date = () => {
    $('#delivery_date').hide();
    $('#close_delivery_date').hide();
    $('#edit_delivery_date').show();
    $('#selected_delivery_date').show();
}

const change_delivery_date = (value) => {
    let delivery_date = (JSON.parse(value)).date;
    if(test) console.log(value, delivery_date);
    $('#delivery_date').hide();
    $('#selected_delivery_date').show();
    $('#selected_delivery_date').html(delivery_date);
    $('#close_delivery_date').hide();
    $('#edit_delivery_date').show();
}

let spin = 0; //button spinners
document.addEventListener("DOMContentLoaded", async function(event) {
  //sessionStorage.removeItem('mealPlanId');//rem
  //sessionStorage.removeItem('customerEmail2'); //rem
  $('.btn_spin_e').hide();
  $('.btn_spin_1').hide();
  $('.btn_spin_2').hide();
  $('.btn_spin_3').hide();
  
  //console.log('page,email,plan', page,email,plan_id);
  if(page === 'email' && !email && plan_id) {
    //let btn = document.getElementById("btn_save_email");
    //$('#btn_save_email').off('click');
    let btn = document.getElementById("btn_email_text");
    btn.innerHTML = 'CHECKOUT';
    //btn.appendChild(document.createTextNode('CHECKOUT'));
  }else if(page === 'email' && !email && !plan_id) {
    //$('#btn_save_email').off('click');
    //let btn = document.getElementById("btn_save_email");
    let btn = document.getElementById("btn_email_text");
    btn.innerHTML = 'VIEW PLANS';
    //btn.appendChild(document.createTextNode('GET STARTED!'));
  }

  if(page === 'plans'){
    //$('.plans').show();
    //console.log(email);
    //return;
    
    //setup delivery dates dropdown selector
    const base_date_str = "November 12, 2021"; //Friday
    const base_week = 287; //goes with base date above
    const day_ms = 1000*60*60*24; //miliseconds in a day

    let today = new Date();
    let base_date = new Date(base_date_str);
    let time_diff = today.getTime() - base_date.getTime();
    let week_diff = Math.floor(time_diff/day_ms/7) + 1;
    let start_week = base_week + week_diff;

    base_date.setDate(base_date.getDate() + (week_diff + 1) * 7 - 4); //monday
    let start_date_1 = String(base_date);
    base_date.setDate(base_date.getDate() + 7);
    let start_date_2 = String(base_date);
    base_date.setDate(base_date.getDate() + 7);
    let start_date_3 = String(base_date);

    let delivery_dates = `
    <option value='{"date":"${start_date_1.substr(0,10)}","week":${start_week}}' selected>${start_date_1.substr(0,10)}</option>
    <option value='{"date":"${start_date_2.substr(0,10)}","week":${start_week + 1}}'>${start_date_2.substr(0,10)}</option>
    <option value='{"date":"${start_date_3.substr(0,10)}","week":${start_week + 2}}'>${start_date_3.substr(0,10)}</option>
    `;
    //console.log(delivery_dates);
    $('#delivery_date').html(delivery_dates);
    $('#delivery_date').hide();
    $('#selected_delivery_date').html(start_date_1.substr(0,10));
    $('#close_delivery_date').hide();
    $('#edit_delivery_date').show();
  }
}); //doc.ready

const select_plan = (plan_id, plan_title, plan_i) => {
  spin = plan_i;
  localStorage.setItem('mealPlanId', plan_id);
  let start_date = $('#delivery_date option:selected').val();
  sessionStorage.setItem('startDate', start_date);
  console.log('selected', plan_title, plan_id, spin, start_date);
  if(email || sessionStorage.getItem('email_page')) {
    checkout(plan_id, start_date);
  }else{
    window.location.href = '/pages/email';
  }
}
  
const saves_email = async (section_id, email) => {
  //console.log('save',email);
  if(!email) return;
  //await checkEmailExistsOnRecharge(email);
  //return;
  if(test) console.log(section_id,email);
  localStorage.setItem('customerEmail',window.btoa(email)); 
  if(plan_id) {
    let start_date = sessionStorage.getItem('startDate');
    setTimeout(() => {
      checkout(plan_id, start_date);
    }, 1000);
  }else{
    window.location.href = `/pages/${plan_page}`;
  }
}

async function checkout(variant_id, start_date, regular=true) {
  if(regular){
    $('.select-plan-group-item-button').off('click');
    $('.btn_spin_e').show();
    $(`.btn_spin_${spin}`).show();
    localStorage.removeItem('mealPlanId');
    sessionStorage.removeItem('startDate');
  }
  let cart = await jQuery.get('/cart.js');
  //console.log(JSON.parse(cart).items);
  let items = JSON.parse(cart).items;
  console.log(items);
  if(!items.find(i => i.title.includes('Gift'))){
    await jQuery.post('/cart/clear.js');
  }

  data = {
    "id": variant_id,
    "quantity": 1,
    "properties": {
      "shipping_interval_frequency": '1',
      "shipping_interval_unit_type": 'week',
      "start_date": start_date || null,
      "discount": localStorage.getItem("discount") || null
    }
  }
  //await jQuery.post('/cart/clear.js');
  jQuery.ajax({
    type: 'POST',
    url: '/cart/add.js',
    data: data,
    dataType: 'json',
    success: function() {
      if(items.find(i => i.title.includes('Gift'))){
        window.location.href = '/cart';
      }else{
        reChargeProcessCart(start_date);
      }
    }
  });
}

const reChargeProcessCart = async(start_date) => {
  //return; //rem
  function get_cookie(name){ return( document.cookie.match('(^|; )'+name+'=([^;]*)')||0 )[2] }
  do {
    token=get_cookie('cart');
  }
  while(token == undefined);
  let ga_linker;
  try { ga_linker = ga.getAll()[0].get('linkerParam') } catch(err) { ga_linker ='' }
  //console.log('ga linker', ga_linker);
  let paramCustomer = "";
  let email = localStorage.getItem("customerEmail") || null;
  let discount = localStorage.getItem("discount") || null;
  if (discount) {
    paramCustomer += `&discount=${discount}`;
  }
  //const start_date = sessionStorage.getItem('startDate') || null;
  const checkout = Boolean(localStorage.getItem("checkout")) || false;
  if (email) {
    if(!email.includes('@')) email = window.atob(email);
    if(!checkout) await checkEmailExistsOnRecharge(email);
    paramCustomer += `&customerEmail=${email}`;
  }else{
    return;
  }

  if (start_date) {
    paramCustomer += `&startDate=${start_date}`;
  }

  //paramCustomer += `&fb_pixel_id=${localStorage.getItem("fb_pixel_id")}&fb_access_token=${localStorage.getItem("fb_pixel_access_token")}`;
  //console.log(paramCustomer);
  //return;

  //switch for testing on calm mountain
  let staging = false;
  let href = window.location.href;
  if(href.includes('calm-mountain')) staging = true;

  let myshopify_domain;
  //myshopify_domain='{{ shop.permanent_domain }}'
  if(staging){
    myshopify_domain='calm-mountain.myshopify.com';
    window.location.href = "https://checkout.rechargeapps.com/r/checkout?myshopify_domain="+myshopify_domain+"&cart_token="+token+"&"+ga_linker+paramCustomer;
  }else{
    myshopify_domain='sprinly-organic-plant-based-meal-delivery.myshopify.com';
    window.location.href = "https://checkout.sprinly.com/r/checkout?myshopify_domain="+myshopify_domain+"&cart_token="+token+"&"+ga_linker+paramCustomer;
  }
}

/*
deployment of order workflow(s) (select plan and gather email - go to checkout from either page if other was already selected):
-templates: page.email, page.plans
-snippets: no-meals-checkout.liquid
-sections: page-email, page-plans (existing modified)
-pages: email (with template page.email), subscription (change: add redirect to page, line 1)
-change text-and-image-1 section on home page to save email to session storage email2
*/

//} //scope end